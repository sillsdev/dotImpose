name: Publish to NuGet

on:
    workflow_dispatch:

jobs:
    build:
        uses: ./.github/workflows/build.yml

    publish:
        needs: build
        runs-on: ubuntu-latest
        # needs.build.outputs.version is the full version emitted by build.yml (steps.version)

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  name: nuget-packages-${{ needs.build.outputs.version }}
                  path: nupkg/

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 8.0.x

            - name: Confirm publish
              run: |
                  echo "ðŸš€ Publishing NuGet packages:"
                  ls -la nupkg/
                  echo ""
                  echo "Version: ${{ needs.build.outputs.version }}"
                  echo "Packages will be published to NuGet.org"

            - name: Publish to NuGet
              run: |
                  for file in nupkg/*.nupkg; do
                    echo "Publishing $file"
                    dotnet nuget push "$file" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
                  done

            - name: Publish success
              run: |
                  echo "âœ… Successfully published to NuGet!"
                  echo "ðŸ“¦ Version: ${{ needs.build.outputs.version }}"
                  echo "ðŸ”— Check your package at: https://www.nuget.org/packages/sillsdev.dotImpose/"
